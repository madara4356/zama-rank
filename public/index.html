<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ZAMA RANK ‚Äî Share Card (Premium)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg1:#020613; --bg2:#061026;
  --muted:#9fb0bf;
  --accent1:#ffd24b; --accent2:#ff6b6b;
  --card: rgba(255,255,255,0.03);
  --ok: #3ee6a8; --danger:#ff7b7b;
  --glass: rgba(255,255,255,0.03);
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg1),var(--bg2));font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;color:#eaf3fb}
#app{min-height:100vh;display:flex;flex-direction:column;align-items:center;padding:18px}
.container{max-width:940px;width:100%}
.top{display:flex;align-items:center;gap:12px;margin-bottom:14px}
.logo{width:48px;height:48px;border-radius:10px;background:linear-gradient(135deg,var(--accent1),var(--accent2));display:flex;align-items:center;justify-content:center;overflow:hidden}
.logo img{width:100%;height:100%;object-fit:cover}
.title{font-weight:800;font-size:18px}
.subtitle{color:var(--muted);font-size:13px;margin-top:2px}

.search-shell{background:var(--card);padding:14px;border-radius:14px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 10px 30px rgba(0,0,0,0.45);display:flex;gap:12px;align-items:center;margin-bottom:16px}
.search-shell input{flex:1;padding:12px 14px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;font-size:16px;height:44px}
.btn{padding:10px 14px;border-radius:12px;border:0;background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#061020;font-weight:800;cursor:pointer}
.btn.gray{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);min-width:80px}

.results{margin-top:18px;display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:14px;align-items:start;width:100%}
.card{background:var(--card);padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 8px 28px rgba(0,0,0,0.45)}
.card h3{margin:0 0 8px}
.footer{display:flex;justify-content:space-between;align-items:center;width:100%;color:var(--muted);margin-top:18px;font-size:13px}
.powered{display:flex;gap:10px;align-items:center}
.powered img{width:44px;height:44px;border-radius:8px;object-fit:cover}

.hidden{display:none}

@media (max-width:560px){
  .search-shell{flex-direction:column;align-items:stretch}
  .search-shell input{width:100%}
}
</style>
</head>
<body>
  <div id="app">
    <div class="container">
      <div class="top">
        <div class="logo"><img id="siteLogo" src="zama-logo.png" alt="Zama"></div>
        <div>
          <div class="title">ZAMA SZN 5 RANK</div>
          <div class="subtitle">Search X handle (e.g. @0x_madara_)</div>
        </div>
      </div>

      <div class="search-shell" role="search" aria-label="Search X handle">
        <input id="username" type="text" placeholder="@your_handle" />
        <button id="searchBtn" class="btn">üîé Search</button>
        <button id="clearBtn" class="btn gray">Clear</button>
        <button id="shareBtn" class="btn">Share Card</button>
      </div>

      <div id="resultArea" class="hidden"></div>

      <div class="footer">
        <div>Made with ‚ù§Ô∏è for Zama ‚Äî love & powered by madara</div>
        <a href="https://x.com/0x_madara_" target="_blank" rel="noopener noreferrer" class="powered">
          <img id="poweredImg" src="madara.png" alt="madara"><div style="font-weight:700">madara</div>
        </a>
      </div>
    </div>
  </div>

  <!-- canvas used to draw the premium slim share card -->
  <canvas id="shareCanvas" width="1200" height="640" style="display:none"></canvas>

<script>
/* =========================
   CONFIG & HELPERS
   ========================= */
const API_BASE = '/api/check';
const TOTAL_FETCHED = 1500;
const OG_NFT_TOP = 1006;
const SHARE_TOP = 100;

const $ = id => document.getElementById(id);
function fmt(n,d=6){ if(n==null||!isFinite(Number(n))) return '-'; return Number(n).toFixed(d); }
function money(n){ if(n==null||!isFinite(Number(n))) return '-'; return '$' + Number(n).toLocaleString(); }

/* preloaded images */
const IMGS = {logo:null, powered:null, avatar:null};
function preload(){
  const l = new Image(); l.src='zama-logo.png'; l.onload=()=>IMGS.logo=l; l.onerror=()=>IMGS.logo=null;
  const p = new Image(); p.src='madara.png'; p.onload=()=>IMGS.powered=p; p.onerror=()=>IMGS.powered=null;
}

/* fetch avatar (unavatar) */
async function loadAvatar(handle){
  return new Promise(resolve=>{
    const img = new Image(); img.crossOrigin='anonymous';
    img.onload = ()=>{ IMGS.avatar = img; resolve(true); };
    img.onerror = ()=>{ IMGS.avatar = null; resolve(false); };
    img.src = `https://unavatar.io/x/${encodeURIComponent(handle)}?fallback=true`;
  });
}

/* progress helper (0..100) */
function progress(rank){
  if(!isFinite(rank)) return 0;
  rank = Number(rank);
  if(rank <= 100) return Math.round((100 - rank) / 99 * 100);
  if(rank >= TOTAL_FETCHED) return 0;
  return Math.round((TOTAL_FETCHED - rank) / (TOTAL_FETCHED - 100) * 100);
}

/* compute simple payout assumption for share winners
   top1 ~ 1500-2000; top100 ~ 150-260; interpolate */
function assumedPayout(rank){
  if(!isFinite(rank)) return null;
  rank = Math.max(1, Math.min(100, rank));
  const topMin = 1500, topMax = 2000, min100 = 150, max100 = 260;
  const t = (rank - 1)/99;
  const mn = Math.round(topMin + (min100 - topMin)*t);
  const mx = Math.round(topMax + (max100 - topMax)*t);
  return {min:mn, max:mx};
}

/* =========================
   RENDER RESULTS (cards on page)
   ========================= */
function mkCard(title, meta, nextMeta){
  const wrapper = document.createElement('div'); wrapper.className='card';
  const found = meta && meta.found===true && isFinite(Number(meta.rank));
  const rank = found ? Number(meta.rank) : null;
  const ms = found ? meta.mindshare : null;
  const prog = found ? progress(rank) : 0;

  const change = (() => {
    if(!found || !nextMeta || !nextMeta.found) return '-';
    const a = Number(meta.mindshare), b = Number(nextMeta.mindshare);
    if(!isFinite(a) || !isFinite(b)) return '-';
    const diff = a - b; const pct = b===0?0:Math.round((Math.abs(diff)/Math.abs(b))*1000)/10;
    const sign = diff>0 ? '‚ñ≤' : (diff<0 ? '‚ñº' : '-');
    const cls = diff>0 ? 'up' : (diff<0 ? 'down':'');
    return `<span class="ms-change ${cls}" style="font-weight:800;color:${diff>0? '#3ee6a8' : (diff<0? '#ff7b7b':'#9fb0bf')}">${sign} ${pct}% ${diff!==0? '(' + (diff>0?'+':'') + diff.toFixed(6) + ')' : ''}</span>`;
  })();

  wrapper.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3 style="margin:0">${title}</h3>
      <div style="font-weight:800;font-size:22px">${found?rank:'-'}</div>
    </div>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px">
      <div style="color:var(--muted)">Mindshare</div>
      <div style="font-weight:800;font-size:20px">${found?fmt(ms,6):'-'}</div>
    </div>
    <div style="margin-top:10px;color:var(--muted)">Change vs next</div>
    <div style="margin-top:6px">${change}</div>
    <div style="margin-top:10px">
      <div style="height:10px;background:rgba(255,255,255,0.03);border-radius:8px;overflow:hidden">
        <div style="width:${prog}%;height:100%;background:linear-gradient(90deg,var(--accent1),var(--accent2));"></div>
      </div>
      <div style="font-size:12px;color:var(--muted);margin-top:8px">${found ? `Progress to Top 100: ${prog}% ‚Ä¢ Total fetched: ${TOTAL_FETCHED}` : 'Search to show data'}</div>
    </div>
    ${ (title==='month' && found && (rank <= SHARE_TOP)) ? `<div style="margin-top:10px"><span style="display:inline-block;padding:8px 12px;border-radius:999px;background:rgba(62,230,168,0.12);color:#3ee6a8;font-weight:700">Eligible: OG NFT + Revenue Share</span></div>` : ((title==='month' && found && rank <= OG_NFT_TOP) ? `<div style="margin-top:10px"><span style="display:inline-block;padding:8px 12px;border-radius:999px;background:rgba(62,230,168,0.06);color:#3ee6a8;font-weight:700">Eligible: OG NFT</span></div>` : '')}
    <div style="margin-top:12px;font-size:14px;color:var(--muted)">Assumed payout (if eligible): <span style="font-weight:800">${(title==='month' && found && rank<=SHARE_TOP)? (money(assumedPayout(rank).min) + ' ‚Äî ' + money(assumedPayout(rank).max)) : '-'}</span></div>
  `;
  return wrapper;
}

function renderResults(data){
  const container = $('resultArea');
  container.innerHTML = '';
  const order = ['24h','7d','month'];
  for(let i=0;i<order.length;i++){
    const item = data.results && data.results[order[i]] ? data.results[order[i]] : {};
    const nextItem = (i<order.length-1) ? (data.results && data.results[order[i+1]] ? data.results[order[i+1]] : {}) : null;
    container.appendChild( mkCard(order[i], item, nextItem) );
  }
  container.classList.remove('hidden');
}

/* =========================
   SLIM PREMIUM SHARE CARD (canvas)
   ========================= */
function drawPremiumCard(handle, data){
  // canvas is 1200x640 (slim)
  const canvas = $('shareCanvas'); const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;

  // background gradient (soft premium)
  const g = ctx.createLinearGradient(0,0, W, H);
  g.addColorStop(0, '#071025');
  g.addColorStop(1, '#041428');
  ctx.fillStyle = g; ctx.fillRect(0,0,W,H);

  // soft vignette
  ctx.fillStyle = 'rgba(0,0,0,0.18)';
  ctx.beginPath(); ctx.ellipse(W/2, H/2, W*0.55, H*0.55, 0, 0, Math.PI*2); ctx.fill();

  // subtle glass panel for content
  const pad = 36;
  const panelW = W - pad*2, panelH = H - pad*2;
  ctx.fillStyle = 'rgba(255,255,255,0.03)'; ctx.roundRect = function(x,y,w,h,r){ ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); };
  ctx.roundRect(pad, pad, panelW, panelH, 18); ctx.fill();

  // left section: avatar + handle + small meta
  const avatarSize = 128;
  const avatarX = pad + 28;
  const avatarY = pad + 26;

  if(IMGS.avatar){
    // avatar clipped circle
    ctx.save(); ctx.beginPath(); ctx.arc(avatarX + avatarSize/2, avatarY + avatarSize/2, avatarSize/2, 0, Math.PI*2); ctx.closePath(); ctx.clip();
    ctx.drawImage(IMGS.avatar, avatarX, avatarY, avatarSize, avatarSize); ctx.restore();
  } else {
    // fallback circle with logo
    ctx.fillStyle = '#ffd24b'; ctx.beginPath(); ctx.arc(avatarX + avatarSize/2, avatarY + avatarSize/2, avatarSize/2, 0, Math.PI*2); ctx.fill();
    if(IMGS.logo) ctx.drawImage(IMGS.logo, avatarX+16, avatarY+16, avatarSize-32, avatarSize-32);
  }

  // handle large
  ctx.fillStyle = '#eaf3fb'; ctx.font = '700 40px Inter, Arial';
  const handleText = handle.startsWith('@') ? handle : '@' + handle;
  ctx.fillText(handleText, avatarX + avatarSize + 28, avatarY + 44);

  // sub small meta
  ctx.font = '500 18px Inter, Arial'; ctx.fillStyle = 'rgba(234,243,251,0.8)';
  ctx.fillText('Zama rank card', avatarX + avatarSize + 28, avatarY + 74);

  // right large rank & mindshare
  const rightX = W - pad - 260;
  // rank big
  const rankVal = (data.results && data.results['month'] && data.results.month.found) ? Number(data.results.month.rank) : '-';
  ctx.fillStyle = '#ffffff'; ctx.font = '800 80px Inter, Arial'; ctx.textAlign = 'right';
  ctx.fillText(rankVal, rightX + 220, avatarY + 100);

  // mindshare label & value
  const msVal = (data.results && data.results['month'] && data.results.month.found) ? Number(data.results.month.mindshare).toFixed(6) : '-';
  ctx.font = '600 18px Inter, Arial'; ctx.fillStyle = '#9fb0bf'; ctx.textAlign = 'right';
  ctx.fillText('Mindshare', rightX + 220, avatarY + 150);
  ctx.font = '800 28px Inter, Arial'; ctx.fillStyle = '#ffd24b'; ctx.fillText(msVal, rightX + 220, avatarY + 186);

  // small progress bar under handle (overall month progress)
  const pBarX = avatarX + avatarSize + 28;
  const pBarY = avatarY + avatarSize - 6;
  const pBarW = W - pBarX - 40 - 260;
  // compute progress using month rank
  const monthMeta = data.results && data.results.month ? data.results.month : null;
  let prog = 0;
  if(monthMeta && monthMeta.found && isFinite(Number(monthMeta.rank))){
    const r = Number(monthMeta.rank);
    prog = (r<=100) ? Math.round((100-r)/99*100) : Math.round((TOTAL_FETCHED - r) / (TOTAL_FETCHED-100) * 100);
    prog = Math.max(0, Math.min(100, prog));
  }
  ctx.fillStyle = 'rgba(255,255,255,0.04)'; ctx.fillRect(pBarX, pBarY, pBarW, 12);
  ctx.fillStyle = 'linear-gradient(90deg,#ffd24b,#ff6b6b)';
  // draw gradient manually
  const g2 = ctx.createLinearGradient(pBarX,0,pBarX+pBarW,0); g2.addColorStop(0,'#ffd24b'); g2.addColorStop(1,'#ff6b6b');
  ctx.fillStyle = g2; ctx.fillRect(pBarX, pBarY, Math.max(10, pBarW * prog / 100), 12);

  // eligibility badge (month only)
  if(monthMeta && monthMeta.found){
    const r = Number(monthMeta.rank);
    let badgeText = null;
    if(r <= SHARE_TOP) badgeText = 'Eligible: OG NFT + Revenue Share';
    else if(r <= OG_NFT_TOP) badgeText = 'Eligible: OG NFT';
    if(badgeText){
      ctx.fillStyle = 'rgba(62,230,168,0.12)'; ctx.roundRect(pBarX, pBarY + 24, 360, 36, 999); ctx.fill();
      ctx.fillStyle = '#3ee6a8'; ctx.font = '700 18px Inter, Arial'; ctx.textAlign = 'left';
      ctx.fillText(badgeText, pBarX + 16, pBarY + 48);
    }
  }

  // smaller footer line
  ctx.font = '500 14px Inter, Arial'; ctx.fillStyle = '#9fb0bf'; ctx.textAlign='left';
  ctx.fillText('Powered by madara ‚Äî zama-rank.vercel.app', pad + 18, H - 28);

  // return dataURL
  return canvas.toDataURL('image/png');
}

/* share / download logic */
function downloadDataUrl(dataUrl, filename){
  const a = document.createElement('a'); a.href = dataUrl; a.download = filename; document.body.appendChild(a); a.click(); a.remove();
}
async function shareDataUrl(dataUrl, filename, shareText){
  try{
    const byteString = atob(dataUrl.split(',')[1]);
    const ab = new ArrayBuffer(byteString.length);
    const ia = new Uint8Array(ab);
    for(let i=0;i<byteString.length;i++) ia[i] = byteString.charCodeAt(i);
    const blob = new Blob([ab], {type:'image/png'});
    const file = new File([blob], filename, {type:'image/png'});
    if(navigator.canShare && navigator.canShare({files:[file]})){
      await navigator.share({files:[file], text: shareText});
      return true;
    } else {
      downloadDataUrl(dataUrl, filename);
      window.open(`https://x.com/intent/tweet?text=${encodeURIComponent(shareText)}`, '_blank');
      return false;
    }
  }catch(err){
    alert('Share failed: ' + (err.message || err));
    return false;
  }
}

/* =========================
   UI interactions
   ========================= */
let lastSearchData = null;
preload();

async function doSearch(){
  const raw = ($('username').value || '').trim();
  if(!raw){ $('username').focus(); return; }
  const handle = raw.replace(/^@/,'');
  // load avatar
  await loadAvatar(handle);
  // show loader while fetching
  $('resultArea').classList.remove('hidden');
  $('resultArea').innerHTML = '<div class="card"><h3>Loading‚Ä¶</h3><div style="color:var(--muted);margin-top:8px">Fetching leaderboards</div></div>';

  try{
    const res = await fetch(`${API_BASE}?username=${encodeURIComponent(handle)}`);
    if(!res.ok) throw new Error('Network ' + res.status);
    const data = await res.json();
    lastSearchData = { handle, data };
    renderResults(data);
  }catch(err){
    $('resultArea').innerHTML = `<div class="card"><h3>Error</h3><div style="color:var(--muted);margin-top:8px">${err.message}</div></div>`;
    lastSearchData = null;
  }
}

$('searchBtn').addEventListener('click', doSearch);
$('username').addEventListener('keydown', (e)=>{ if(e.key==='Enter') doSearch(); });
$('clearBtn').addEventListener('click', ()=>{
  $('username').value = ''; $('resultArea').classList.add('hidden'); lastSearchData = null;
});

$('shareBtn').addEventListener('click', async ()=>{
  if(!lastSearchData){ alert('Run Search first; Share Card works after search.'); return; }
  const handle = lastSearchData.handle;
  const data = lastSearchData.data;
  const dataUrl = drawPremiumCard(handle, data);
  const filename = `${handle}-zama-rank.png`;
  const tweetText = `${handle} ‚Äî Zama Rank (month): ${data.results?.month?.rank || '-'} ‚Ä¢ Mindshare: ${data.results?.month?.mindshare || '-'}\nCheck: https://zama-rank.vercel.app`;
  await shareDataUrl(dataUrl, filename, tweetText);
});

/* small fallback: hide results on load */
$('resultArea').classList.add('hidden');
</script>
</body>
</html>
