<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ZAMA RANK</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg: #02070b;
      --card: rgba(255,255,255,0.03);
      --muted: #9fb0bf;
      --accent1: #ffd24b;
      --accent2: #ff6b6b;
      --glass: rgba(255,255,255,0.03);
      --text: #eaf3fb;
      --success: #3ee6a8;
      --danger: #ff7b7b;
    }
    [data-theme="light"]{
      --bg: #f7fafc; --card:#fff; --muted:#5b6b76; --text:#061020; --glass: rgba(0,0,0,0.04);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; min-height:100vh; background: linear-gradient(180deg,var(--bg),#071025 100%);
      color:var(--text); font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial; -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    .wrap{max-width:980px;margin:18px auto;padding:16px;}
    .toprow{display:flex;gap:12px;align-items:center;justify-content:space-between}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:48px;height:48px;border-radius:10px;overflow:hidden;background:linear-gradient(135deg,var(--accent1),var(--accent2));display:flex;align-items:center;justify-content:center}
    .logo img{width:100%;height:100%;object-fit:cover}
    h1{margin:0;font-size:18px}
    .subtitle{color:var(--muted);font-size:13px;margin-top:2px}

    .controls{display:flex;gap:12px;align-items:center}
    .theme-toggle{padding:8px 12px;border-radius:10px;border:0;background:transparent;color:var(--muted);cursor:pointer}
    .history-btn{padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--muted);cursor:pointer}

    .search-shell{margin-top:14px;background:var(--card);padding:16px;border-radius:14px;border:1px solid rgba(255,255,255,0.03)}
    .search-row{display:flex;gap:10px;align-items:center}
    .search-row input{flex:1;padding:14px 16px;border-radius:12px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;font-size:16px}
    .actions{display:flex;gap:10px}
    .btn{padding:10px 14px;border-radius:12px;border:0;cursor:pointer;font-weight:700}
    .btn-search{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#061020}
    .btn-clear{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}

    .suggestions{position:relative}
    .suggest-list{position:absolute;left:0;right:0;top:44px;background:var(--card);border-radius:10px;padding:6px;border:1px solid rgba(255,255,255,0.03);z-index:10}
    .suggest-item{padding:8px;border-radius:8px;cursor:pointer;color:var(--text)}
    .suggest-item:hover{background:rgba(255,255,255,0.02)}

    .results{margin-top:16px;display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:14px}
    .card{background:var(--card);padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
    .card h3{margin:0 0 8px;font-size:14px}
    .row{display:flex;justify-content:space-between;align-items:center;margin:8px 0}
    .label{color:var(--muted);font-size:13px}
    .value{font-size:20px;font-weight:800}

    /* progress bar */
    .progress-shell{height:12px;background:rgba(255,255,255,0.03);border-radius:999px;overflow:hidden}
    .progress-bar{height:100%;width:0;border-radius:999px;background:linear-gradient(90deg,var(--accent1),var(--accent2));transition:width .6s ease}

    /* indicator */
    .ms-change{display:inline-flex;gap:6px;align-items:center;font-weight:700}
    .ms-change.up{color:var(--success)} .ms-change.down{color:var(--danger)}

    .history-panel{margin-top:12px;background:transparent;color:var(--muted);font-size:13px;display:flex;gap:8px;flex-wrap:wrap}
    .history-chip{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.02);cursor:pointer;border:1px solid rgba(255,255,255,0.03)}

    .bottom-actions{display:flex;gap:10px;align-items:center;margin-top:12px;flex-wrap:wrap}
    .share-btn{padding:8px 12px;border-radius:10px;border:0;background:linear-gradient(90deg,var(--accent1),var(--accent2));cursor:pointer;font-weight:700;color:#061020}

    /* skeleton */
    .skeleton{background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.04), rgba(255,255,255,0.02));height:14px;border-radius:6px}

    @media (max-width:520px){
      .toprow{flex-direction:column;align-items:flex-start;gap:8px}
      .search-row{flex-direction:column}
      .suggest-list{top:56px}
    }
  </style>
</head>
<body>
  <div class="wrap" id="app">
    <div class="toprow">
      <div class="brand">
        <div class="logo"><img src="zama-logo.png" alt="logo" /></div>
        <div>
          <h1>ZAMA RANK</h1>
          <div class="subtitle">Search X handle (e.g. @0x_madara_)</div>
        </div>
      </div>

      <div class="controls">
        <button id="themeToggle" class="theme-toggle">Toggle theme</button>
        <button id="openHistory" class="history-btn">History</button>
      </div>
    </div>

    <div class="search-shell" role="search">
      <div class="search-row">
        <div style="flex:1;position:relative" class="suggestions">
          <input id="username" type="text" placeholder="@your_handle" autocomplete="off" />
          <div id="suggestList" class="suggest-list" style="display:none"></div>
        </div>

        <div class="actions">
          <button id="searchBtn" class="btn btn-search">ðŸ”Ž Search</button>
          <button id="clearBtn" class="btn btn-clear">Clear</button>
        </div>
      </div>

      <div class="bottom-actions">
        <div id="historyPanel" class="history-panel" style="display:none"></div>
        <button id="shareBtn" class="share-btn" title="Generate share image">Share Card</button>
      </div>
    </div>

    <div id="resultArea" class="results"></div>
  </div>

  <!-- hidden canvas for share card -->
  <canvas id="cardCanvas" width="1200" height="630" style="display:none"></canvas>

  <script>
    // --------- helpers ---------
    const apiBase = '/api/check';
    const STORAGE_KEY = 'zama_history_v1';
    const THEME_KEY = 'zama_theme_v1';

    function fmtNum(n,dec=8){ if(n==null||!isFinite(Number(n))) return '-'; return Number(n).toFixed(dec) }

    function saveHistory(handle){
      handle = handle.toLowerCase();
      if(!handle) return;
      const arr = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
      const idx = arr.indexOf(handle);
      if(idx !== -1) arr.splice(idx,1);
      arr.unshift(handle);
      if(arr.length > 20) arr.length = 20;
      localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
    }
    function loadHistory(){ return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]') }

    function setTheme(t){
      if(t) document.documentElement.setAttribute('data-theme', t);
      else document.documentElement.removeAttribute('data-theme');
      localStorage.setItem(THEME_KEY, t || '');
    }
    function initTheme(){
      const t = localStorage.getItem(THEME_KEY);
      if(t) setTheme(t);
      else {
        // prefer dark by default
        setTheme(window.matchMedia && window.matchMedia('(prefers-color-scheme:light)').matches ? 'light' : '');
      }
    }

    // progress percent: prefer rank100_mindshare ratio; fallback by rank
    function computeProgress(meta){
      if(!meta) return 0;
      const ms = Number(meta.mindshare);
      const rank100_ms = Number(meta.rank100_mindshare);
      if(isFinite(ms) && isFinite(rank100_ms) && rank100_ms > 0){
        return Math.max(0, Math.min(1, ms / rank100_ms));
      }
      if(isFinite(meta.rank)){
        // fallback: closer to #1 -> higher percent; use top 1500 as baseline
        return Math.max(0, Math.min(1, (1500 - meta.rank) / 1500));
      }
      return 0;
    }

    // compute change between this timeframe and the next (24h vs 7d, 7d vs month), return {dir:'up'|'down'|'same', pct:..}
    function computeChange(curr, next){
      const a = Number(curr?.mindshare); const b = Number(next?.mindshare);
      if(!isFinite(a) || !isFinite(b)) return {dir:'same', pct:0};
      if(b === 0) return {dir: a>0 ? 'up' : 'same', pct: 100};
      const diff = a - b;
      const pct = Math.abs(diff / (Math.abs(b) || 1)) * 100;
      return {dir: diff > 0 ? 'up' : (diff < 0 ? 'down' : 'same'), pct: Math.round(pct*10)/10};
    }

    // skeleton card
    function skeletonCard(){
      const c = document.createElement('div'); c.className='card';
      c.innerHTML = '<h3 class="skeleton" style="width:90px;height:18px"></h3>'
        + '<div class="row"><div class="label skeleton" style="width:64px;height:12px"></div><div class="value skeleton" style="width:80px;height:20px"></div></div>'
        + '<div class="row"><div class="label skeleton" style="width:90px;height:12px"></div><div class="value skeleton" style="width:120px;height:20px"></div></div>'
        + '<div class="row"><div class="label skeleton" style="width:120px;height:12px"></div><div class="value skeleton" style="width:60px;height:20px"></div></div>';
      return c;
    }

    // build card UI with features
    function mkCard(title, meta, neighborMeta=null){
      const c = document.createElement('div'); c.className='card';
      const rank = meta?.rank ?? null;
      const ms = meta?.mindshare ?? null;
      const total = 1500; // fixed

      const progressPct = Math.round(computeProgress(meta)*100);

      // change indicator (compare to neighbor timeframe)
      const change = computeChange(meta, neighborMeta);
      const changeHtml = change.dir === 'same' ? '-' : `<span class="ms-change ${change.dir}">${change.dir==='up' ? 'â–²' : 'â–¼'} ${change.pct}%</span>`;

      c.innerHTML = `
        <h3>${title}</h3>
        <div class="row"><div class="label">Rank</div><div class="value">${rank ?? '-'}</div></div>
        <div class="row"><div class="label">Mindshare</div><div class="value">${fmtNum(ms)}</div></div>
        <div class="row"><div class="label">Change vs next</div><div class="value">${changeHtml}</div></div>
        <div style="margin-top:8px">
          <div class="progress-shell" aria-hidden="true"><div class="progress-bar" style="width:${progressPct}%"></div></div>
          <div style="font-size:12px;color:var(--muted);margin-top:6px">Progress to #100: ${progressPct}% â€¢ Total fetched: ${total}</div>
        </div>
      `;
      return c;
    }

    // suggestions UI
    const usernameEl = document.getElementById('username');
    const suggestList = document.getElementById('suggestList');
    function showSuggestions(filter=''){
      const arr = loadHistory();
      const list = arr.filter(x => x.includes(filter.toLowerCase())).slice(0,8);
      if(list.length === 0){ suggestList.style.display='none'; return; }
      suggestList.innerHTML = list.map(h => `<div class="suggest-item" data-h="${h}">@${h}</div>`).join('');
      suggestList.style.display = 'block';
    }
    suggestList.addEventListener('click', (e) => {
      const item = e.target.closest('.suggest-item'); if(!item) return;
      usernameEl.value = item.dataset.h; suggestList.style.display='none';
    });

    usernameEl.addEventListener('input', (e) => {
      const v = e.target.value || '';
      showSuggestions(v.replace(/^@/,''));
    });
    document.addEventListener('click', (e) => { if(!e.target.closest('.suggestions')) suggestList.style.display='none'; });

    // history panel
    const historyPanel = document.getElementById('historyPanel');
    function renderHistory(){
      const arr = loadHistory();
      if(arr.length === 0){ historyPanel.style.display='none'; return; }
      historyPanel.style.display = 'flex';
      historyPanel.innerHTML = arr.map(h => `<div class="history-chip" data-h="${h}">@${h} âœ•</div>`).join('');
    }
    historyPanel.addEventListener('click', (e) => {
      const chip = e.target.closest('.history-chip'); if(!chip) return;
      const handle = chip.dataset.h;
      // if clicked on text or X, decide - we'll treat whole chip click as run; X delete when clicked near end - simple approach: prompt
      if(confirm(`Run search @${handle}? (Cancel to remove from history)`)) {
        usernameEl.value = handle; performSearch();
      } else {
        // remove
        let arr = loadHistory(); arr = arr.filter(x => x !== handle); localStorage.setItem(STORAGE_KEY, JSON.stringify(arr)); renderHistory();
      }
    });

    // share card generator - simple canvas image
    async function generateShareCard(handle, data){
      const canvas = document.getElementById('cardCanvas');
      const ctx = canvas.getContext('2d');
      // background
      ctx.fillStyle = '#071025';
      ctx.fillRect(0,0,canvas.width,canvas.height);
      // header
      ctx.fillStyle = '#ffd24b';
      ctx.font = 'bold 48px Inter, Arial';
      ctx.fillText(handle.startsWith('@')?handle:`@${handle}`, 60, 120);
      // draw three boxes for 24h,7d,month
      const keys = ['24h','7d','month'];
      ctx.font = 'bold 36px Inter, Arial';
      for(let i=0;i<3;i++){
        const x = 60 + i*360; const y = 190;
        ctx.fillStyle = '#061020';
        ctx.fillRect(x, y, 320, 240);
        ctx.fillStyle = '#eaf3fb';
        ctx.fillText(keys[i], x+18, y+44);
        const meta = data.results[keys[i]] || {};
        ctx.font = 'bold 32px Inter, Arial';
        ctx.fillText('Rank: ' + (meta.rank || '-'), x+18, y+100);
        ctx.fillText('MS: ' + (meta.mindshare ? Number(meta.mindshare).toFixed(6) : '-'), x+18, y+150);
      }

      // return blob URL
      return new Promise(resolve => canvas.toBlob(blob => resolve(blob)));
    }

    async function downloadShare(handle, data){
      const blob = await generateShareCard(handle, data);
      if(!blob) return alert('Failed to generate image');
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `${handle}-zama-rank.png`;
      document.body.appendChild(a); a.click();
      a.remove(); URL.revokeObjectURL(url);
    }

    // --------- main search logic ---------
    const resultArea = document.getElementById('resultArea');
    const searchBtn = document.getElementById('searchBtn');
    const clearBtn = document.getElementById('clearBtn');
    const shareBtn = document.getElementById('shareBtn');
    const openHistoryBtn = document.getElementById('openHistory');

    async function performSearch(){
      const raw = (usernameEl.value||'').trim();
      if(!raw) { usernameEl.focus(); return; }
      const handle = raw.replace(/^@/,'');
      // UI: show skeletons
      resultArea.innerHTML = '';
      for(let i=0;i<3;i++) resultArea.appendChild(skeletonCard());
      saveHistory(handle); renderHistory(); showSuggestions('');

      searchBtn.disabled = true;
      try{
        const r = await fetch(`${apiBase}?username=${encodeURIComponent(handle)}`);
        if(!r.ok) throw new Error('Network '+r.status);
        const data = await r.json();
        resultArea.innerHTML = '';
        const order = ['24h','7d','month'];
        for(let i=0;i<order.length;i++){
          const key = order[i];
          const neighbor = order[i+1] ? data.results[order[i+1]] : null;
          resultArea.appendChild(mkCard(key, data.results[key], neighbor));
        }
        // attach share action payload
        shareBtn.onclick = () => downloadShare(handle, data);
      } catch(err){
        resultArea.innerHTML = `<div class="card"><h3>Error</h3><div style="color:var(--muted);margin-top:6px">${err.message}</div></div>`;
      } finally { searchBtn.disabled = false }
    }

    // buttons
    searchBtn.addEventListener('click', performSearch);
    clearBtn.addEventListener('click', ()=>{ usernameEl.value=''; resultArea.innerHTML=''; });
    openHistoryBtn.addEventListener('click', ()=>{ const panel = document.getElementById('historyPanel'); panel.style.display = panel.style.display==='flex'?'none':'flex'; });

    // share button fallback when no search yet
    shareBtn.addEventListener('click', async () => {
      const handle = (usernameEl.value||'').trim();
      if(!handle) return alert('Search for a handle first to generate card');
      // try fetch latest data quickly
      try{ const r = await fetch(`${apiBase}?username=${encodeURIComponent(handle.replace(/^@/,''))}`); const data = await r.json(); await downloadShare(handle.replace(/^@/,''), data); }
      catch(e){ alert('Failed to generate card: '+e.message) }
    });

    // init
    initTheme();
    renderHistory();
    showSuggestions('');
    // keyboard Enter submits
    usernameEl.addEventListener('keydown', (e) => { if(e.key==='Enter') performSearch(); });
  </script>
</body>
</html>