<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>ZAMA RANK ‚Äî Share Card Fixed</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg-ink-1: #020617;
    --bg-ink-2: #071025;
    --card: rgba(255,255,255,0.03);
    --muted: #9fb0bf;
    --accent1: #ffd24b;
    --accent2: #ff6b6b;
    --text: #eaf3fb;
    --ok: #3ee6a8;
    --bad: #ff7b7b;
    --footer-h: 72px;
    --footer-transition: 220ms;
    --vignette-alpha: 0.45;
    --noise-opacity: 0.04;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;padding:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--text);-webkit-font-smoothing:antialiased;}
  body { background-color: #050814; min-height:100vh; }

  #app {
    min-height:100dvh; display:flex; flex-direction:column;
    background-image:
      radial-gradient(800px 420px at 10% 15%, rgba(6,18,36,0.14), rgba(6,18,36,0) 22%),
      radial-gradient(600px 360px at 85% 28%, rgba(12,26,44,0.12), rgba(12,26,44,0) 30%),
      linear-gradient(180deg, rgba(3,8,18,0.85) 0%, rgba(4,10,20,0.95) 55%, rgba(6,12,24,1) 100%);
    background-repeat:no-repeat; background-attachment: fixed; position:relative; overflow-x:hidden;
  }
  #app::after{
    content: ""; position: fixed; left: 0; right: 0; top: 0; bottom: 0; pointer-events: none;
    background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='200' height='200' viewBox='0 0 200 200'><filter id='n'><feTurbulence baseFrequency='0.9' numOctaves='2' stitchTiles='stitch'/><feColorMatrix type='saturate' values='0'/></filter><rect width='100%' height='100%' filter='url(%23n)' opacity='0.08' /></svg>");
    opacity: var(--noise-opacity); mix-blend-mode: overlay; z-index: 0;
  }
  #app::before{
    content: ""; position: fixed; left:0; right:0; bottom:0; height: 42vh; pointer-events: none;
    background: linear-gradient(180deg, rgba(0,0,0,0) 0%, rgba(0,0,0,var(--vignette-alpha)) 100%); z-index: 0;
  }

  .wrap{ position:relative; z-index: 2; max-width:940px; margin:18px auto; padding:18px 18px 18px;
    padding-bottom: calc(var(--footer-h) + env(safe-area-inset-bottom, 0px) + 12px);
    flex:1; display:flex; flex-direction:column; transition:padding-bottom .12s ease; }

  .topbar{display:flex;align-items:center;justify-content:flex-start;gap:12px; z-index:2}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:48px;height:48px;border-radius:10px;overflow:hidden;background:linear-gradient(135deg,var(--accent1),var(--accent2));display:flex;align-items:center;justify-content:center;box-shadow:0 10px 28px rgba(0,0,0,0.45)}
  .logo img{width:100%;height:100%;object-fit:cover}
  h1{margin:0;font-size:20px}
  .subtitle{color:var(--muted);font-size:13px;margin-top:2px}

  .skip-link{position:absolute;left:-9999px;top:auto;background:#061020;color:white;padding:8px 12px;border-radius:8px;z-index:9999}
  .skip-link:focus{ left:12px; top:12px; outline:3px solid rgba(255,215,75,0.18); }

  .search-shell{margin-top:14px;background: rgba(255,255,255,0.02); padding:18px;border-radius:14px;border:1px solid rgba(255,255,255,0.03); box-shadow: 0 10px 36px rgba(2,6,12,0.6); backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px); }
  .search-row{display:flex;gap:12px;align-items:center}
  .search-inner{flex:1;min-width:0}
  input[type="text"]{ width:100%; padding:14px 16px; border-radius:12px; border:1px solid rgba(255,255,255,0.04); background:transparent; color:inherit; font-size:16px; height:56px; outline:none; }

  .actions{display:flex;gap:12px;align-items:center;flex:0 0 auto}
  .btn{padding:12px 18px;border-radius:12px;border:0;cursor:pointer;font-weight:800;display:inline-flex;align-items:center;justify-content:center;min-height:48px}
  .btn:focus{ outline: 3px solid rgba(255,215,75,0.14); outline-offset:2px; }
  .btn-search{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#061020;box-shadow:0 10px 30px rgba(0,0,0,0.5);min-width:120px}
  .btn-clear{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);min-width:88px}
  .btn-share{background:linear-gradient(90deg,var(--accent1),var(--accent2)); color:#061020; min-width:132px;}

  .results{margin-top:18px;display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:14px;align-items:start}
  @media (min-width: 900px) {
    .results {
      grid-template-columns: repeat(3, minmax(260px, 1fr));
    }
  }

  .card{background: linear-gradient(180deg, rgba(255,255,255,0.016), rgba(255,255,255,0.008)); padding:16px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 8px 28px rgba(0,0,0,0.45); backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px); z-index:2}
  .card h3{margin:0 0 10px;font-size:14px}
  .row{display:flex;justify-content:space-between;align-items:center;margin:8px 0}
  .label{color:var(--muted);font-size:13px}
  .value{font-size:20px;font-weight:800; font-variant-numeric: tabular-nums;}
  .value.mindshare{ font-size:20px; color:var(--accent1); text-align:right; white-space:nowrap; }
  .badge{display:inline-block;padding:6px 10px;border-radius:999px;font-weight:700;font-size:13px}
  .badge.ok{background:rgba(62,230,168,0.12);color:var(--ok);border:1px solid rgba(62,230,168,0.12)}

  .progress-shell{height:12px;background:rgba(255,255,255,0.03);border-radius:999px;overflow:hidden}
  .progress-bar{height:100%;width:0;border-radius:999px;background:linear-gradient(90deg,var(--accent1),var(--accent2));transition:width .6s ease}

  .ms-change{display:inline-flex;gap:8px;align-items:center;font-weight:800;white-space:nowrap;font-variant-numeric: tabular-nums}
  .ms-change.up{color:var(--ok)} .ms-change.down{color:var(--bad)}
  .ms-change .abs{font-weight:700;color:rgba(255,255,255,0.85);font-size:0.95em;margin-left:6px}
  hr.sep{border:none;border-top:1px solid rgba(255,255,255,0.03);margin:10px 0}
  .results-empty{color:var(--muted);margin-top:16px}

  footer.site-footer{
    position:fixed; left:0; right:0; bottom:0; height: var(--footer-h);
    display:flex; align-items:center; justify-content:center; padding:12px 18px;
    background: linear-gradient(180deg, rgba(8,10,12,0.06), rgba(8,10,12,0.18));
    border-top: 1px solid rgba(255,255,255,0.02); box-shadow: 0 -6px 18px rgba(0,0,0,0.18);
    z-index:40; transform: translateY(0); transition: transform var(--footer-transition) cubic-bezier(.22,.9,.28,1);
    will-change: transform; backdrop-filter: blur(6px) saturate(120%); -webkit-backdrop-filter: blur(6px) saturate(120%); overflow: visible;
  }
  footer.site-footer::before{ content: ""; position: absolute; left: 0; right: 0; top: -48px; height: 48px; pointer-events: none; background: linear-gradient(180deg, rgba(0,0,0,0), rgba(8,10,12,0.12)); z-index: 39; transition: opacity 180ms ease; opacity: 1; }
  footer.site-footer.hidden::before { display:none !important; } footer.site-footer.hidden { transform: translateY(calc(100% + env(safe-area-inset-bottom, 0px))); }
  .footer-inner{max-width:940px;width:100%;display:flex;align-items:center;justify-content:space-between;gap:12px;color:var(--muted);font-size:14px}
  .footer-text{flex:1; min-width:0}
  a.powered{ text-decoration:none;color:inherit;display:flex;gap:12px;align-items:center;flex:0 0 auto}
  a.powered img{ width:56px; height:56px; border-radius:8px; object-fit:cover; box-shadow:0 8px 22px rgba(0,0,0,0.45) }

  .toast{ position:fixed; left:50%; transform:translateX(-50%); bottom: calc(var(--footer-h) + 16px); background: #061020; color: #fff; padding:8px 12px; border-radius:10px; box-shadow: 0 8px 30px rgba(0,0,0,0.5); z-index:12000; font-weight:600; opacity:0; transition:opacity 180ms ease, transform 180ms ease; will-change:opacity, transform; }
  .toast.show{ opacity: 1; transform: translateX(-50%) translateY(-6px); }

  :focus:not(:focus-visible) { outline: none; }
  @media (max-width:760px){ h1{font-size:18px} }
  @media (max-width:560px){
    .search-row{flex-direction:column;align-items:stretch} .search-inner{width:100%}
    .actions{flex-wrap:nowrap;justify-content:space-between} .btn{flex:1 1 auto; min-width:0} .btn + .btn{margin-left:8px}
    .footer-inner{padding:0 6px; font-size:13px} a.powered img{width:48px;height:48px} :root{ --footer-h:64px; }
  }
  @media (max-height:520px){ .wrap{ padding-bottom: calc(var(--footer-h) + env(safe-area-inset-bottom,0px) + 6px); } }
  @media (prefers-reduced-motion: reduce){ * { transition: none !important; animation: none !important; scroll-behavior: auto !important; } .toast{ transition:none; } }
</style>
</head>
<body>
  <a href="#username" class="skip-link">Skip to search</a>

  <div id="app" role="application" aria-label="Zama Rank app">
    <div class="wrap" id="wrap">
      <div class="topbar" role="banner">
        <div class="brand" aria-hidden="false">
          <div class="logo" aria-hidden="true"><img id="logoImg" src="zama-logo.png" alt=""></div>
          <div><h1>ZAMA SZN 5 RANK</h1><div class="subtitle">Search X handle (e.g. @0x_madara_)</div></div>
        </div>
      </div>

      <form class="search-shell" role="search" aria-label="Search X handle" onsubmit="return false;">
        <div class="search-row">
          <div class="search-inner">
            <label for="username" class="sr-only" style="position:absolute;left:-9999px">Search handle</label>
            <input id="username" type="text" placeholder="@your_handle" aria-label="Search handle" autocomplete="off" />
          </div>
          <div class="actions" role="group" aria-label="Search actions">
            <button id="searchBtn" class="btn btn-search" aria-label="Search">üîé Search</button>
            <button id="clearBtn" class="btn btn-clear" aria-label="Clear search">Clear</button>
            <button id="shareCardBtn" class="btn btn-share" aria-label="Share card">Share Card</button>
          </div>
        </div>
      </form>

      <div id="resultStatus" aria-live="polite" aria-atomic="true" style="position:absolute;left:-9999px;top:auto;"></div>
      <div id="resultArea" class="results" role="region" aria-live="polite" aria-label="Search results" style="display:none"></div>
      <div id="emptyHint" class="results-empty" role="status">Search to show data</div>
    </div>

    <footer class="site-footer" id="siteFooter" aria-hidden="false" role="contentinfo">
      <div class="footer-inner">
        <div class="footer-text" id="footerText">Made with ‚ù§Ô∏è for Zama by Madara </div>
        <a class="powered" href="https://x.com/0x_madara_" target="_blank" rel="noopener noreferrer" id="poweredLink" aria-label="Madara on X">
          <img id="poweredAvatar" src="madara.png" alt="madara">
        </a>
      </div>
    </footer>
  </div>

  <canvas id="cardCanvas" width="1200" height="630" style="display:none; width:1200px; height:630px" aria-hidden="true"></canvas>

<script>
/* -------- CONFIG -------- */
const API_BASE = '/api/check';
const TOTAL_FETCHED = 1500;
const OG_NFT_TOP = 1006;
const SHARE_TOP = 100;

/* Toggle this while testing ‚Äî set to false for production */
const DEBUG_CANVAS_PREVIEW = true;

/* cache */
const resultsCache = new Map();

/* helpers */
const $ = id => document.getElementById(id);
function money(n){ if(n==null || !isFinite(Number(n))) return '-'; return '$' + Number(n).toLocaleString(); }
function fmtNum(n, d=6){ if(n==null || !isFinite(Number(n))) return '-'; return Number(n).toFixed(d); }
function progressToTop100(rank){
  if(!isFinite(rank)) return 0;
  rank = Number(rank);
  if(rank <= 100) return Math.max(0, Math.min(1, (100-rank)/99));
  return Math.max(0, Math.min(1, (1500-rank)/(1500-100)));
}

/* üî• NEW: compute change from delta (with fallbacks) */
function computePeriodChange(meta) {
  const curr = Number(meta?.mindshare);

  // try several possible field names, fall back to 0
  let delta = meta?.mindshareDelta;
  if (delta == null) delta = meta?.mindshare_delta;
  if (delta == null) delta = meta?.delta;
  if (delta == null) delta = 0;

  delta = Number(delta);

  if (!isFinite(curr) || !isFinite(delta)) {
    // treat as no change instead of "-"
    return { dir: 'same', pctText: '0.0%', absText: '', pct: 0, abs: 0 };
  }

  const prev = curr - delta;
  const pct  = prev === 0 ? 0 : (delta / Math.abs(prev)) * 100;

  const pctRounded = Math.round(pct * 10) / 10;
  const absRounded = Math.round(delta * 1e6) / 1e6;

  const dir = delta > 0 ? 'up' : delta < 0 ? 'down' : 'same';
  const pctText = dir === 'same' ? '0.0%' : `${Math.abs(pctRounded)}%`;
  const absText = absRounded === 0 ? '' : `(${absRounded>0?'+':''}${absRounded})`;

  return { dir, pctText, absText, pct: pctRounded, abs: absRounded };
}

/* preload images */
const _pre = {logo:null, powered:null, avatar:null};
function preloadStatic(){
  const l = new Image(); l.src='zama-logo.png'; l.onload=()=>_pre.logo=l; l.onerror=()=>_pre.logo=null;
  const p = new Image(); p.src='madara.png'; p.onload=()=>{ _pre.powered=p; $('poweredAvatar').src='madara.png'; } ; p.onerror=()=>_pre.powered=null;
}
preloadStatic();

async function loadAvatar(handle){
  return new Promise(resolve=>{
    const img = new Image(); img.crossOrigin='anonymous';
    img.onload = ()=>{ _pre.avatar = img; resolve(true); };
    img.onerror = ()=>{ _pre.avatar = null; resolve(false); };
    img.src = `https://unavatar.io/x/${encodeURIComponent(handle)}?fallback=true`;
  });
}

/* toast */
function showToast(msg, ms=2200){
  const existing = document.querySelector('.toast');
  if(existing) existing.remove();
  const t = document.createElement('div');
  t.className = 'toast';
  t.setAttribute('role','status');
  t.setAttribute('aria-live','polite');
  t.textContent = msg;
  document.body.appendChild(t);
  requestAnimationFrame(()=> t.classList.add('show'));
  setTimeout(()=> {
    t.classList.remove('show');
    setTimeout(()=> t.remove(), 200);
  }, ms);
}

/* UI show/hide */
function hideResults(){ $('resultArea').style.display = 'none'; $('emptyHint').style.display='block'; $('resultStatus').textContent = 'No results displayed'; }
function showResults(){ $('resultArea').style.display = 'grid'; $('emptyHint').style.display='none'; }

/* build card */
function mkCard(title, meta){
  const el = document.createElement('div'); el.className='card';

  const found = !!meta && meta.found === true && Number.isFinite(Number(meta.rank));
  const rank = found ? Number(meta.rank) : null;
  const ms = found ? meta.mindshare : null;

  const ch = computePeriodChange(found ? meta : {});

  let changeHtml = '-';
  if(found){
    if(ch.dir === 'same') {
      changeHtml = `<span class="ms-change">${ch.pctText}</span>`;
    } else {
      const arrow = ch.dir === 'up' ? '‚ñ≤' : '‚ñº';
      changeHtml = `<span class="ms-change ${ch.dir}">${arrow} ${ch.pctText}<span class="abs">${ch.absText}</span></span>`;
    }
  }

  const mindshareHtml = found ? `<div class="value mindshare">${fmtNum(ms,6)}</div>` : `<div class="value mindshare">-</div>`;

  const labelForChange =
    title === '24h' ? 'Change in last 24h' :
    title === '7d'  ? 'Change in last 7 days' :
                      'Change in last 30 days';

  let badgeHtml = '';
  if((title==='30d' || title==='month') && found){
    if(rank <= SHARE_TOP) badgeHtml = `<div style="margin-top:8px"><span class="badge ok">Eligible for OG NFT + Revenue Share</span></div>`;
    else if(rank <= OG_NFT_TOP) badgeHtml = `<div style="margin-top:8px"><span class="badge ok">Eligible for OG NFT</span></div>`;
  }

  let payoutSectionHtml = '';
  if ((title === '30d' || title === 'month') && found && rank <= SHARE_TOP) {
    const topMin = 1500, topMax=2000, min100=150, max100=260;
    const t = (Math.min(100, Math.max(1, rank)) - 1)/99;
    const min = Math.round(topMin + (min100 - topMin)*t);
    const max = Math.round(topMax + (max100 - topMax)*t);
    const payoutHtml = `${money(min)} - ${money(max)}`;

    payoutSectionHtml = `
      <hr class="sep" />
      <div class="row">
        <div class="label">Assumed payout (if eligible)</div>
        <div class="value">${payoutHtml}</div>
      </div>
    `;
  }

  el.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3>${title}</h3>
      <div style="text-align:right;font-weight:800;font-size:20px">${found?rank:'-'}</div>
    </div>
    <div class="row"><div class="label">Mindshare</div>${mindshareHtml}</div>
    <div class="row"><div class="label">${labelForChange}</div><div style="text-align:right">${found? changeHtml : '-'}</div></div>
    ${badgeHtml}
    ${payoutSectionHtml}
  `;
  return el;
}

/* share card canvas (unchanged except using computePeriodChange) */
async function drawCanvasLayout(handle, data){
  const LOGICAL_W = 1200;
  const LOGICAL_H = 630;
  const canvas = $('cardCanvas');

  const showPreview = DEBUG_CANVAS_PREVIEW;

  if(showPreview){
    canvas.style.display = 'block';
    canvas.style.position = 'fixed';
    canvas.style.left = '8px';
    canvas.style.top = '8px';
    canvas.style.zIndex = 99999;
    canvas.style.boxShadow = '0 12px 50px rgba(0,0,0,0.6)';
    canvas.style.borderRadius = '12px';
    canvas.style.background = '#061020';
  }

  const DPR = Math.min(window.devicePixelRatio || 1, 2.5);
  canvas.width = Math.round(LOGICAL_W * DPR);
  canvas.height = Math.round(LOGICAL_H * DPR);
  canvas.style.width = LOGICAL_W + 'px';
  canvas.style.height = LOGICAL_H + 'px';

  const ctx = canvas.getContext('2d');
  ctx.setTransform(DPR, 0, 0, DPR, 0, 0);
  ctx.clearRect(0, 0, LOGICAL_W, LOGICAL_H);

  try { await (document.fonts && document.fonts.ready); } catch(e){}
  await new Promise(r=> setTimeout(r, 40));

  const bg = ctx.createLinearGradient(0, 0, 0, LOGICAL_H);
  bg.addColorStop(0, '#081822'); bg.addColorStop(1, '#00121a');
  ctx.fillStyle = bg; ctx.fillRect(0, 0, LOGICAL_W, LOGICAL_H);

  const pad = 28;
  const panelX = pad, panelY = pad, panelW = LOGICAL_W - pad*2, panelH = LOGICAL_H - pad*2;
  roundRectFill(ctx, panelX, panelY, panelW, panelH, 20, 'rgba(255,255,255,0.02)');

  const avatarSize = 96, leftColX = panelX + 26, leftColY = panelY + 20, avatarX = leftColX, avatarY = leftColY;
  if(_pre.avatar){
    ctx.save();
    ctx.beginPath();
    ctx.arc(avatarX + avatarSize/2, avatarY + avatarSize/2, avatarSize/2, 0, Math.PI*2);
    ctx.closePath(); ctx.clip();
    ctx.drawImage(_pre.avatar, avatarX, avatarY, avatarSize, avatarSize);
    ctx.restore();
    ctx.beginPath();
    ctx.arc(avatarX + avatarSize/2, avatarY + avatarSize/2, avatarSize/2 - 3, 0, Math.PI*2);
    ctx.lineWidth = 3; ctx.strokeStyle = 'rgba(255,255,255,0.06)'; ctx.stroke();
  } else {
    roundRectFill(ctx, avatarX, avatarY, avatarSize, 10, '#ffd24b');
  }

  const handleText = handle.startsWith('@') ? handle : '@' + handle;
  ctx.fillStyle = '#fff'; fitText(ctx, handleText, avatarX + avatarSize + 18, avatarY + 34, panelW * 0.28, { weight:700, size:28, family:'Inter, Arial' });
  ctx.fillStyle = '#9fb0bf'; ctx.font = '400 14px Inter, Arial'; ctx.fillText('Zama rank card', avatarX + avatarSize + 18, avatarY + 56);

  const leftReserve = avatarX + avatarSize + 26;
  const rightReserve = 36;
  const boxesX = panelX + leftReserve;
  const boxesW = panelW - leftReserve - rightReserve - 24;
  const gap = 20;
  const boxCount = 3;
  const boxW = Math.floor((boxesW - gap*(boxCount-1)) / boxCount);
  const boxH = 130;
  const boxY = panelY + avatarSize + 28;

  const r24 = data.results?.['24h'] || {};
  const r7  = data.results?.['7d'] || {};
  const r30b = data.results?.['30d'] || data.results?.month || {};

  drawStatBox(ctx, boxesX + 0*(boxW+gap), boxY, boxW, boxH, '24H', r24);
  drawStatBox(ctx, boxesX + 1*(boxW+gap), boxY, boxW, boxH, '7D', r7);
  drawStatBox(ctx, boxesX + 2*(boxW+gap), boxY, boxW, boxH, '30D', r30b);

  ctx.fillStyle = 'rgba(255,255,255,0.6)';
  ctx.font = '500 12px Inter, Arial';
  ctx.fillText('Powered by madara ‚Äî zama-rank.vercel.app', panelX + 18, panelY + panelH - 16);

  if(showPreview){
    setTimeout(()=>{ try{ canvas.style.display='none'; }catch(e){} }, 1200);
  }

  return canvas.toDataURL('image/png');

  function roundRectFill(ctx, x, y, w, h, r, fillStyle){
    ctx.beginPath(); ctx.moveTo(x + r, y); ctx.arcTo(x + w, y, x + w, y + h, r); ctx.arcTo(x + w, y + h, x, y + h, r); ctx.arcTo(x, y + h, x, y, r); ctx.closePath();
    ctx.fillStyle = fillStyle; ctx.fill();
  }

  function fitText(ctx, text, x, y, maxWidth, opts = {}){
    const family = opts.family || 'Inter, Arial'; const weight = opts.weight || 700;
    let size = opts.size || 28; ctx.font = `${weight} ${size}px ${family}`;
    while(size > 10 && ctx.measureText(text).width > maxWidth){ size = Math.floor(size * 0.94); ctx.font = `${weight} ${size}px ${family}`; }
    ctx.textAlign = 'left'; ctx.fillText(text, x, y);
  }

  function drawStatBox(ctx, x, y, w, h, title, meta){
    roundRectFill(ctx, x, y, w, h, 12, 'rgba(255,255,255,0.02)');
    ctx.strokeStyle = 'rgba(255,255,255,0.06)'; ctx.lineWidth = 2; ctx.strokeRect(x+1, y+1, w-2, h-2);

    ctx.fillStyle = '#9fb0bf'; ctx.font = '700 13px Inter, Arial'; ctx.fillText(title, x + 12, y + 22);
    const rankVal = (meta && meta.found && isFinite(Number(meta.rank))) ? String(meta.rank) : '-';
    ctx.font = '800 22px Inter, Arial'; ctx.fillStyle = '#fff'; ctx.textAlign = 'right'; ctx.fillText(rankVal, x + w - 12, y + 26); ctx.textAlign = 'left';

    ctx.font = '400 12px Inter, Arial'; ctx.fillStyle = '#9fb0bf'; const msText = (meta && meta.found) ? Number(meta.mindshare).toFixed(8) : '-';
    ctx.fillText('Mindshare: ' + msText, x + 12, y + 48);

    const ch = computePeriodChange(meta || {});
    if(meta && meta.found){
      const isUp = ch.dir === 'up';
      if(ch.dir === 'same'){
        ctx.fillStyle = '#9fb0bf';
        ctx.font = '800 13px Inter, Arial';
        ctx.fillText('0.0%', x + 12, y + 72);
      } else {
        ctx.fillStyle = isUp ? '#3ee6a8' : '#ff7b7b';
        ctx.font = '800 13px Inter, Arial';
        ctx.fillText((isUp ? '‚ñ≤ ' : '‚ñº ') + ch.pctText, x + 12, y + 72);
        if(ch.absText){
          ctx.fillStyle = 'rgba(255,255,255,0.85)'; ctx.font = '700 12px Inter, Arial'; ctx.textAlign = 'right';
          ctx.fillText(ch.absText, x + w - 12, y + 72); ctx.textAlign = 'left';
        }
      }
    }

    const barX = x + 12, barY = y + h - 28, barW = w - 24, barH = 10;
    roundRectFill(ctx, barX, barY, barW, barH, 999, 'rgba(255,255,255,0.03)');
    const prog = (meta && meta.found && Number.isFinite(Number(meta.rank))) ? Math.round(progressToTop100(Number(meta.rank))*100) : 0;
    const fillW = Math.max(barW * (prog/100), Math.min(barW * 0.06, barW));
    const g = ctx.createLinearGradient(barX, 0, barX + barW, 0);
    g.addColorStop(0, '#ffd24b'); g.addColorStop(1, '#ff6b6b');
    roundRectFill(ctx, barX, barY, fillW, barH, 999, g);
    ctx.fillStyle = '#9fb0bf'; ctx.font = '400 11px Inter, Arial';
    ctx.fillText(`Progress to Top 100: ${prog}% ‚Ä¢ Total fetched: ${TOTAL_FETCHED}`, x + 12, y + h - 8);
  }
}

/* share image */
function shareImageFromDataURL(dataUrl, handle, data){
  try{
    const byteString = atob(dataUrl.split(',')[1]);
    const ab = new ArrayBuffer(byteString.length);
    const ia = new Uint8Array(ab);
    for(let i=0;i<byteString.length;i++) ia[i]=byteString.charCodeAt(i);
    const blob = new Blob([ab], {type:'image/png'});
    const file = new File([blob], `${handle}-zama-rank.png`, {type:'image/png'});

    if(navigator.canShare && navigator.canShare({files:[file]})){
      navigator.share({
        files: [file],
        text: `${handle} ‚Äî Zama Rank (30d): ${data.results?.['30d']?.rank || data.results?.month?.rank || '-'} ‚Ä¢ Mindshare: ${data.results?.month?.mindshare || '-' }\nCheck: https://zama-rank.vercel.app`
      }).then(()=> { showToast('Shared successfully'); }).catch(()=> { showToast('Share cancelled or failed'); });
      return;
    }

    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = `${handle}-zama-rank.png`; document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=>URL.revokeObjectURL(url),2000);
    showToast('Image downloaded');
    const text = `${handle} ‚Äî Zama Rank (30d): ${data.results?.['30d']?.rank || data.results?.month?.rank || '-'} ‚Ä¢ Mindshare: ${data.results?.month?.mindshare || '-' }\nCheck: https://zama-rank.vercel.app`;
    window.open(`https://x.com/intent/tweet?text=${encodeURIComponent(text)}`, '_blank');
  }catch(err){
    showToast('Share failed'); alert('Share failed: '+(err.message||err));
  }
}

/* debounce (unused but kept) */
function debounce(fn, wait){
  let t = null;
  return function(...args){ clearTimeout(t); t = setTimeout(()=> fn.apply(this, args), wait); };
}

let lastSearch = null;

async function performSearchImmediate(){
  const raw = ($('username').value||'').trim();
  if(!raw){ $('username').focus(); return; }
  const handle = raw.replace(/^@/,'').toLowerCase();
  showResults(); const status = $('resultStatus'); status.textContent = 'Fetching data‚Ä¶';
  $('resultArea').innerHTML = '';

  for(let i=0;i<3;i++){
    const s=document.createElement('div');
    s.className='card';
    s.innerHTML = `<h3>Loading‚Ä¶</h3><div style="color:var(--muted);margin-top:6px">Fetching data</div>`;
    $('resultArea').appendChild(s);
  }

  await loadAvatar(handle);

  if(resultsCache.has(handle)){
    const data = resultsCache.get(handle);
    renderResults(handle, data);
    status.textContent = `Showing cached results for ${handle}`;
    lastSearch = { handle, data };
    return;
  }

  try{
    const res = await fetch(`${API_BASE}?username=${encodeURIComponent(handle)}`);
    if(!res.ok) throw new Error('Network ' + res.status);
    const data = await res.json();
    const results = data.results || {};
    if(!results['30d'] && results['month']) results['30d'] = results['month'];
    if(!results['month'] && results['30d']) results['month'] = results['30d'];
    resultsCache.set(handle, data);
    renderResults(handle, data);
    status.textContent = `Results loaded for ${handle}`;
    lastSearch = { handle, data };
  }catch(err){
    const el = document.createElement('div');
    el.className='card';
    el.innerHTML = `<h3>Error</h3><div style="color:var(--muted);margin-top:6px">${err.message}</div>`;
    $('resultArea').innerHTML = '';
    $('resultArea').appendChild(el);
    status.textContent = `Error fetching results`;
    lastSearch = null;
    showToast('Error fetching data');
  }
}

const performSearch = debounce(performSearchImmediate, 300);

function renderResults(handle, data){
  const container = $('resultArea'); container.innerHTML = '';
  const results = data.results || {};
  if(!results['30d'] && results['month']) results['30d'] = results['month'];
  if(!results['month'] && results['30d']) results['month'] = results['30d'];
  const order = ['24h','7d','30d'];
  for(let i=0;i<order.length;i++){
    const k = order[i];
    container.appendChild( mkCard(k, results[k]||{}) );
  }
  showResults();
}

/* Share button */
$('shareCardBtn').addEventListener('click', async (e) => {
  e.preventDefault();
  if(!lastSearch){
    showToast('Run a search first');
    $('username').focus();
    return;
  }
  const { handle, data } = lastSearch;
  try{
    const dataUrl = await drawCanvasLayout(handle, data);
    shareImageFromDataURL(dataUrl, handle, data);
  }catch(err){
    showToast('Share failed');
    console.error(err);
    alert('Share failed: '+(err.message||err));
  }
});

/* Search / Enter */
$('searchBtn').addEventListener('click', (e)=> {
  e.preventDefault();
  performSearchImmediate();
});
$('username').addEventListener('keydown', (e)=>{
  if(e.key==='Enter'){
    e.preventDefault();
    performSearchImmediate();
  }
});

/* no auto-search while typing */
/* $('username').addEventListener('input', (e)=> { performSearch(); }); */

/* Clear */
$('clearBtn').addEventListener('click', (e)=>{
  e.preventDefault();
  $('username').value = '';
  lastSearch = null;
  hideResults();
  showToast('Cleared');
});

/* footer hide/show */
(function setupFooterVisibility(){
  const footer = $('siteFooter'); if(!footer) return;
  let lastY = window.scrollY || 0; let ticking = false;
  function onScroll(){
    const y = window.scrollY || 0;
    if (y > lastY + 6) {
      footer.classList.add('hidden');
    } else if (y < lastY - 6) {
      footer.classList.remove('hidden');
    }
    lastY = y;
    ticking = false;
  }
  window.addEventListener('scroll', function(){
    if (ticking) return;
    ticking = true;
    requestAnimationFrame(onScroll);
  }, { passive: true });
  window.addEventListener('touchstart', ()=> footer.classList.remove('hidden'), {passive:true});
  window.addEventListener('load', ()=> footer.classList.remove('hidden'));
})();

/* initial */
hideResults();
</script>
</body>
</html>
